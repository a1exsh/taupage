<source>
  @type tail
  path /var/log/syslog
  pos_file /var/log/td-agent/syslog.pos
  tag scalyr.*
  <parse>
    @type none
  </parse>
</source>

<source>
  @type tail
  path /var/log/application.log
  pos_file /var/log/td-agent/application.log.pos
  tag scalyr.*
  <parse>
    @type none
  </parse>
</source>

<source>
  @type tail
  path /var/log/auth.log
  pos_file /var/log/td-agent/auth.log.pos
  tag scalyr.*
  <parse>
    @type none
  </parse>
</source>

<filter **.application.log>
  @type record_transformer
  <record>
    parser {{ scalyr_application_log_parser }}
  </record>
</filter>

<filter **.syslog **.auth.log>
  @type record_transformer
  <record>
    parser {{ scalyr_syslog_log_parser }}
  </record>
</filter>

<filter scalyr.**>
  @type prometheus
  <metric>
    name fluentd_input_status_num_records_total
    type counter
    desc The total number of incoming records
    <labels>
      tag ${tag}
      hostname ${hostname}
    </labels>
  </metric>
</filter>

<match scalyr.**>
  @type copy
  <store>
    @type scalyr
    api_write_token  {{ scalyr_api_key }}
    server_attributes {
      "application_id": "{{ application_id }}",
      "application_version": "{{ application_version }}",
      "aws_account": "{{ aws_account }}",
      "aws_region": "{{ aws_region }}",
      "image": "{{ image }}",
      "serverHost": "{{ application_id }}",
      "source": "{{ source }}",
      "stack": "{{ stack }}"
    }
    ssl_verify_peer false
    scalyr_server https://eu.scalyr.com/
  </store>
  <store>
    @type prometheus
    <metric>
      name fluentd_output_status_num_records_total
      type counter
      desc The total number of outgoing records
      <labels>
        tag ${tag}
        hostname ${hostname}
      </labels>
    </metric>
  </store>
</match>

<system>
  log_level {{ fluentd_loglevel }}
</system>

<source>
  @type prometheus
  bind 0.0.0.0
  port 9110
  metrics_path /metrics
</source>

<source>
  @type prometheus_output_monitor
  interval 60
  <labels>
    hostname ${hostname}
  </labels>
</source>
